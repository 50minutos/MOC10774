USE DB

EXEC SP_TABLES

INSERT PESSOA 
VALUES (2, 'XXX')

INSERT PESSOA 
VALUES (2, 'YYY')

SELECT * 
FROM PESSOA

INSERT PESSOA 
VALUES (3, 'XXX'), 
	(3, 'YYY')

SELECT * 
FROM PESSOA

--ASP, IIS -> ISCLIENTCONNECTED

BEGIN TRAN --TRANSACTION
BEGIN TRAN
BEGIN TRAN

SELECT @@TRANCOUNT

COMMIT --TRANSACTION --TRAN

SELECT @@TRANCOUNT

COMMIT 
COMMIT 

SELECT @@TRANCOUNT

BEGIN TRAN
BEGIN TRAN
BEGIN TRAN

ROLLBACK --TRANSACTION --TRAN

SELECT @@TRANCOUNT

ROLLBACK 

COMMIT

GO

CREATE TABLE T
(
	C INT
)

BEGIN TRAN

INSERT T VALUES (1)

BEGIN TRAN

INSERT T VALUES (2)

COMMIT

ROLLBACK

SELECT * 
FROM T

SELECT @@TRANCOUNT

BEGIN TRAN X
BEGIN TRAN Y

COMMIT TRAN X

SELECT @@TRANCOUNT

COMMIT TRAN Y

SELECT @@TRANCOUNT

BEGIN TRAN X
BEGIN TRAN Y

ROLLBACK TRAN X

SELECT @@TRANCOUNT

BEGIN TRAN X
BEGIN TRAN Y

COMMIT TRAN X

--ROLLBACK TRAN Y --ERRO
ROLLBACK TRAN X

SELECT @@TRANCOUNT

BEGIN TRAN X

CREATE TABLE TABELA
(
	CAMPO INT
)

BEGIN TRAN Y

INSERT TABELA VALUES (1)

SELECT @@TRANCOUNT

COMMIT TRAN X
COMMIT TRAN Y

TRUNCATE TABLE TABELA

BEGIN TRAN X

INSERT TABELA VALUES (10)

BEGIN TRAN Y

INSERT TABELA VALUES (100)

SAVE TRAN Y 

INSERT TABELA VALUES (1000)

SELECT @@TRANCOUNT

ROLLBACK TRAN Y

SELECT @@TRANCOUNT

COMMIT

SELECT * 
FROM TABELA

BEGIN TRAN
BEGIN TRAN
BEGIN TRAN
BEGIN TRAN

SELECT @@TRANCOUNT

SELECT 1/0

SELECT @@TRANCOUNT

INSERT T
VALUES ('FADFAFDA')

SELECT @@TRANCOUNT

GO

CREATE PROC USP_PESSOA_INSERT_TRY_TRAN
	@ID INT, 
	@NOME VARCHAR(50)
AS
	BEGIN TRY
		BEGIN TRAN
		
		INSERT PESSOA
		VALUES (@ID, @NOME)
		
		COMMIT
	END TRY
	BEGIN CATCH
		ROLLBACK

		--;THROW
	END CATCH
GO

EXEC USP_PESSOA_INSERT_TRY_TRAN 1, 'EPAMINONDAS'

SELECT * 
FROM PESSOA

EXEC USP_PESSOA_INSERT_TRY_TRAN 10, 'EPAMINONDAS'

SELECT * 
FROM PESSOA
