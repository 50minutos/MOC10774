USE MASTER

IF EXISTS(SELECT * FROM SYS.DATABASES WHERE NAME='DB')
	DROP DATABASE DB

CREATE DATABASE DB
GO

USE DB

CREATE TABLE DBO.PESSOA
(
    ID INT PRIMARY KEY, 
	NOME VARCHAR(50)
)

------------------

BEGIN TRY
   INSERT DBO.PESSOA VALUES(1, 'ADÃO')
   INSERT DBO.PESSOA VALUES(1, 'EVA')
END TRY
BEGIN CATCH
    PRINT 'CAPTUREI A EXCEPTION'
END CATCH

------------------

BEGIN TRY
   INSERT DBO.PESSOA VALUES(1, 'CAIM')
END TRY
BEGIN CATCH
    PRINT 'CAPTUREI A EXCEPTION'
    ;THROW
END CATCH

-----------------

GO

CREATE PROC USP_PESSOA_INSERT_OLD
	@ID INT,
	@NOME VARCHAR(50)
AS
	DECLARE @ERROR INT

	INSERT PESSOA
	VALUES (@ID, @NOME)

	SET @ERROR = @@ERROR
	
	IF @ERROR <> 0 
		GOTO ERRO
	
	GOTO FIM
ERRO:
	PRINT 'DEU PAU NA BAGAÇA - ' + CONVERT(VARCHAR, @ERROR)
FIM:
	PRINT 'FIM'
GO

EXEC USP_PESSOA_INSERT_OLD 1, 'ABEL'

GO

CREATE PROC USP_PESSOA_INSERT_NEW 
	@ID INT,
	@NOME VARCHAR(50)
AS
	BEGIN TRY
		INSERT PESSOA
		VALUES (@ID, @NOME)
	END TRY
	BEGIN CATCH
		SELECT ERROR_NUMBER(), 
			ERROR_SEVERITY(), 
			ERROR_STATE(), 
			ERROR_MESSAGE(), 
			ERROR_PROCEDURE(), 
			ERROR_LINE()
		--;THROW
	END CATCH

	PRINT 'FIM'
GO

EXEC USP_PESSOA_INSERT_NEW 1, 'ABEL'

EXEC SP_HELPTEXT USP_PESSOA_INSERT_NEW

--OLD
RAISERROR('PAU NA BAGAÇA', 16, 1)

EXEC SP_ADDMESSAGE 50001, 16, 'PAU NA BAGAÇA'

SELECT * 
FROM SYS.MESSAGES 
WHERE message_id = 2627

RAISERROR(50001, 16, 1)

EXEC sp_addmessage 50002, 16, 'ERRO INSERINDO NA TABELA %s'

RAISERROR(50002, 16, 1, 'PESSOA')

--NEW
--;THROW -> DENTRO DO CATCH

